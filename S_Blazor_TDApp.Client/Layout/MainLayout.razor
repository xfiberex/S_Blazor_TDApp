@using S_Blazor_TDApp.Client.Extensions
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@attribute [Authorize]
@inherits LayoutComponentBase

@inject NavigationManager Navigation
@inject AuthenticationStateProvider autenticacionProvider

<div class="page d-flex">
    <!-- Sidebar -->
    <div class="sidebar @(collapseNavMenu ? "collapsed" : "")">
        <NavMenu Collapse="@collapseNavMenu" CollapseChanged="@ToggleNavMenu" />
    </div>

    <!-- Main Content -->
    <div class="main-content flex-grow-1">
        <!-- Top Bar -->
        <div class="top-row d-flex justify-content-between align-items-center px-4 py-2 border-bottom">
            <div>
                <AuthorizeView Context="authContext">
                    <Authorized>
                        @{
                            // Extraer el nombre y el email del usuario autenticado
                            var nombre = authContext.User.Identity?.Name ?? "Usuario";
                            var email = authContext.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
                        }
                        <span>Sesión iniciada: @nombre - (@email)</span>
                    </Authorized>
                    <NotAuthorized>
                        <span>Invitado</span>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
            <div>
                <a class="me-3" href="https://learn.microsoft.com/aspnet/core/" target="_blank">Acerca de</a>
                <a href="javascript:void(0)" @onclick="CerrarSesion">Salir</a>
            </div>
        </div>

        <!-- Page Body -->
        <article class="content px-4 py-3">
            @Body
        </article>
    </div>
</div>

@code {
    private bool collapseNavMenu = true;

    private void ToggleNavMenu(bool collapse)
    {
        collapseNavMenu = collapse;
    }

    private async Task CerrarSesion()
    {
        var autenticacionExt = (AutenticacionExtension)autenticacionProvider;
        await autenticacionExt.ActualizarEstadoAutenticacion(null);
        Navigation.NavigateTo("/", true);
    }
}